{% extends "base.html" %}

{% block title %}Тестирование NLP{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <!-- Заголовок страницы -->
            <div class="text-center mb-5">
                <h1 class="display-5">
                    <i class="fas fa-brain me-3"></i>Тестирование NLP анализа
                </h1>
                <p class="lead">Анализируйте банковские разговоры с помощью искусственного интеллекта</p>
            </div>

            <!-- Форма анализа -->
            <div class="card shadow-lg mb-5">
                <div class="card-header">
                    <i class="fas fa-microscope me-2"></i>Анализ разговора
                </div>
                <div class="card-body">
                    <form id="analysisForm">
                        <div class="mb-4">
                            <label for="conversation-text" class="form-label">
                                <i class="fas fa-comments"></i>Текст разговора
                            </label>
                            <textarea class="form-control form-control-lg" id="conversation-text" 
                                      rows="8" placeholder="Введите текст разговора для анализа..." required></textarea>
                            <div class="form-text">
                                <i class="fas fa-info-circle"></i>
                                Вставьте текст разговора между клиентом и оператором
                            </div>
                        </div>

                        <!-- Примеры разговоров -->
                        <div class="mb-4">
                            <label class="form-label">
                                <i class="fas fa-lightbulb"></i>Примеры разговоров
                            </label>
                            <div class="example-buttons">
                                <button type="button" class="btn btn-outline-secondary" onclick="loadExample('credit')">
                                    <i class="fas fa-credit-card me-2"></i>Кредитная карта
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadExample('deposit')">
                                    <i class="fas fa-piggy-bank me-2"></i>Вклад
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadExample('payment')">
                                    <i class="fas fa-money-bill-wave me-2"></i>Платеж
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadExample('support')">
                                    <i class="fas fa-headset me-2"></i>Поддержка
                                </button>
                                <button type="button" class="btn btn-outline-secondary" onclick="loadExample('complaint')">
                                    <i class="fas fa-exclamation-triangle me-2"></i>Жалоба
                                </button>
                            </div>
                        </div>

                        <div class="row">
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="analysis-type" class="form-label">
                                        <i class="fas fa-cogs"></i>Тип анализа
                                    </label>
                                    <select class="form-select form-select-lg" id="analysis-type" name="analysis_type">
                                        <option value="full">Полный анализ</option>
                                        <option value="sentiment">Только настроения</option>
                                        <option value="intent">Только намерения</option>
                                        <option value="entities">Только сущности</option>
                                        <option value="summary">Краткое содержание</option>
                                    </select>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i>
                                        Выберите тип анализа для выполнения
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-4">
                                    <label for="model-select" class="form-label">
                                        <i class="fas fa-robot"></i>Модель LLM
                                    </label>
                                    <select class="form-select form-select-lg" id="model-select" name="model">
                                        <!-- Эти модели должны быть доступны в вашем локальном Ollama-сервере -->
                                        <option value="llama3.1:8b">Llama 3.1 8B (локально)</option>
                                        <option value="mistral:7b">Mistral 7B (локально)</option>
                                    </select>
                                    <div class="form-text">
                                        <i class="fas fa-info-circle"></i>
                                        Выберите локальную модель для анализа
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="d-flex gap-3">
                            <button type="submit" class="btn btn-primary btn-lg" id="analyze-btn">
                                <i class="fas fa-play me-2"></i>Начать анализ
                            </button>
                            <button type="button" class="btn btn-outline-secondary btn-lg" onclick="clearForm()">
                                <i class="fas fa-eraser me-2"></i>Очистить
                            </button>
                            <button type="button" class="btn btn-success btn-lg" onclick="saveAnalysis()">
                                <i class="fas fa-save me-2"></i>Сохранить
                            </button>
                        </div>
                    </form>
                </div>
            </div>

            <!-- Результаты анализа -->
            <div id="results-section" class="results-section" style="display: none;">
                <div class="card shadow-lg">
                    <div class="card-header bg-success">
                        <i class="fas fa-chart-bar me-2"></i>Результаты анализа
                    </div>
                    <div class="card-body">
                        <div class="result-grid">
                            <!-- Настроения -->
                            <div class="result-card">
                                <h3><i class="fas fa-smile me-2"></i>Настроения</h3>
                                <div id="sentiment-result">
                                    <div class="sentiment-score">
                                        <span class="score-label">Общий тон:</span>
                                        <span class="score-value" id="overall-sentiment">-</span>
                                    </div>
                                    <div class="emotions-chart" id="emotions-chart">
                                        <!-- Эмоции будут добавлены динамически -->
                                    </div>
                                </div>
                            </div>

                            <!-- Намерения -->
                            <div class="result-card">
                                <h3><i class="fas fa-bullseye me-2"></i>Намерения</h3>
                                <div id="intent-result">
                                    <div class="intent-list" id="intent-list">
                                        <!-- Намерения будут добавлены динамически -->
                                    </div>
                                </div>
                            </div>

                            <!-- Сущности -->
                            <div class="result-card">
                                <h3><i class="fas fa-tags me-2"></i>Сущности</h3>
                                <div id="entities-result">
                                    <div class="entities-container" id="entities-container">
                                        <!-- Сущности будут добавлены динамически -->
                                    </div>
                                </div>
                            </div>

                            <!-- Уверенность -->
                            <div class="result-card">
                                <h3><i class="fas fa-chart-line me-2"></i>Уверенность</h3>
                                <div id="confidence-result">
                                    <div class="confidence-container">
                                        <div class="confidence-bar-container">
                                            <span class="confidence-label">Общая уверенность:</span>
                                            <div class="confidence-bar">
                                                <div class="confidence-fill" id="confidence-fill"></div>
                                            </div>
                                            <span class="confidence-value" id="confidence-value">-</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Краткое содержание -->
                        <div class="result-card mt-4">
                            <h3><i class="fas fa-file-alt me-2"></i>Краткое содержание</h3>
                            <div id="summary-result">
                                <p id="summary-text">-</p>
                            </div>
                        </div>

                        <!-- Рекомендации -->
                        <div class="result-card mt-4">
                            <h3><i class="fas fa-lightbulb me-2"></i>Рекомендации</h3>
                            <div id="recommendations-result">
                                <ul id="recommendations-list">
                                    <!-- Рекомендации будут добавлены динамически -->
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- История анализов -->
            <div class="card shadow-lg mt-5">
                <div class="card-header bg-info">
                    <i class="fas fa-history me-2"></i>История анализов
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-hover" id="history-table">
                            <thead>
                                <tr>
                                    <th>Дата</th>
                                    <th>Тип анализа</th>
                                    <th>Настроение</th>
                                    <th>Уверенность</th>
                                    <th>Действия</th>
                                </tr>
                            </thead>
                            <tbody id="history-table-body">
                                <!-- История будет загружена динамически -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Модальное окно для детального просмотра -->
<div class="modal fade" id="detailModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-eye me-2"></i>Детали анализа
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="analysis-detail"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Закрыть</button>
                <button type="button" class="btn btn-primary" onclick="exportAnalysis()">
                    <i class="fas fa-download me-2"></i>Экспорт
                </button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="/static/js/main.js"></script>
<script>
// Примеры разговоров
const examples = {
    credit: `Клиент: Здравствуйте, хочу оформить кредитную карту.
Оператор: Добрый день! Конечно, помогу вам с оформлением. Какая сумма кредитного лимита вас интересует?
Клиент: Хотелось бы лимит в 100 тысяч рублей.
Оператор: Отлично! Для оформления карты с таким лимитом нам понадобятся документы: паспорт, справка о доходах и выписка с основного счета.
Клиент: А какие условия по карте?
Оператор: Кредитная ставка 15.9% годовых, льготный период 55 дней, обслуживание 990 рублей в год.`,
    
    deposit: `Клиент: Добрый день! Хочу открыть вклад.
Оператор: Здравствуйте! С удовольствием помогу с выбором вклада. На какую сумму планируете?
Клиент: 500 тысяч рублей на год.
Оператор: Отлично! У нас есть вклад "Доходный" под 8.5% годовых с капитализацией процентов.
Клиент: А можно ли пополнять вклад?
Оператор: Да, пополнение возможно от 10 тысяч рублей. Досрочное снятие без потери процентов.`,
    
    payment: `Клиент: Здравствуйте, не могу оплатить коммунальные услуги через приложение.
Оператор: Добрый день! Давайте разберемся с проблемой. Что именно происходит при попытке оплаты?
Клиент: Приложение выдает ошибку "Недостаточно средств", но деньги на счете есть.
Оператор: Понятно. Давайте проверим баланс и лимиты. Возможно, установлен дневной лимит на операции.
Клиент: Да, лимит 50 тысяч, а я хочу оплатить 45 тысяч.
Оператор: Все верно! Для увеличения лимита нужно обратиться в отделение банка с паспортом.`,
    
    support: `Клиент: Добрый день! Заблокировали карту, не могу расплатиться.
Оператор: Здравствуйте! Понимаю вашу обеспокоенность. Давайте разберемся. Когда произошла блокировка?
Клиент: Сегодня утром, когда пытался купить билет на самолет.
Оператор: Скорее всего, сработала система безопасности. Для разблокировки нужно подтвердить операцию.
Клиент: Как это сделать?
Оператор: Отправлю SMS-код на ваш номер. Введите его в приложении или назовите мне.`,
    
    complaint: `Клиент: Здравствуйте! Очень недоволен работой вашего банка!
Оператор: Добрый день! Приношу извинения за доставленные неудобства. Расскажите, что произошло?
Клиент: Вчера снял деньги в банкомате, но сумма не сошлась. Списали больше, чем должно быть.
Оператор: Понимаю вашу обеспокоенность. Давайте проверим операции по карте. Можете назвать номер карты?
Клиент: 1234 5678 9012 3456
Оператор: Проверяю... Вижу операцию. Действительно, есть расхождение. Создам заявку на пересчет.`
};

// Загрузка примера
function loadExample(type) {
    const textarea = document.getElementById('conversation-text');
    textarea.value = examples[type] || '';
    textarea.focus();
}

// Очистка формы
function clearForm() {
    document.getElementById('analysisForm').reset();
    document.getElementById('results-section').style.display = 'none';
}

// Сохранение анализа
function saveAnalysis() {
    const text = document.getElementById('conversation-text').value;
    if (!text.trim()) {
        showAlert('Сначала выполните анализ текста', 'warning');
        return;
    }
    
    // Здесь будет логика сохранения
    showAlert('Анализ сохранен в истории', 'success');
}

// Показать уведомление
function showAlert(message, type = 'info') {
    const alertDiv = document.createElement('div');
    alertDiv.className = `alert alert-${type} alert-dismissible fade show`;
    alertDiv.innerHTML = `
        <i class="fas fa-${type === 'warning' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
        ${message}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;
    
    const container = document.querySelector('.container-fluid');
    container.insertBefore(alertDiv, container.firstChild);
    
    setTimeout(() => {
        if (alertDiv.parentNode) {
            alertDiv.remove();
        }
    }, 5000);
}

// Обработка формы анализа
document.getElementById('analysisForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const text = document.getElementById('conversation-text').value.trim();
    if (!text) {
        showAlert('Пожалуйста, введите текст для анализа', 'warning');
        return;
    }
    
    const analyzeBtn = document.getElementById('analyze-btn');
    const originalText = analyzeBtn.innerHTML;
    
    try {
        analyzeBtn.disabled = true;
        analyzeBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>Анализируем...';
        
        const response = await fetch('/api/v1/nlp/analyze', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                text: text,
                analysis_type: document.getElementById('analysis-type').value,
                model: document.getElementById('model-select').value
            })
        });
        
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const result = await response.json();
        displayResults(result);
        
    } catch (error) {
        console.error('Ошибка при анализе:', error);
        showAlert('Ошибка при анализе: ' + error.message, 'danger');
    } finally {
        analyzeBtn.disabled = false;
        analyzeBtn.innerHTML = originalText;
    }
});

// Отображение результатов
function displayResults(data) {
    // Показываем секцию результатов
    document.getElementById('results-section').style.display = 'block';
    
    // Настроения
    if (data.sentiment) {
        document.getElementById('overall-sentiment').textContent = data.sentiment.overall || 'Не определено';
        document.getElementById('overall-sentiment').className = `score-value ${getSentimentClass(data.sentiment.overall)}`;
        
        // Эмоции
        const emotionsChart = document.getElementById('emotions-chart');
        emotionsChart.innerHTML = '';
        
        if (data.sentiment.emotions) {
            Object.entries(data.sentiment.emotions).forEach(([emotion, score]) => {
                const emotionItem = document.createElement('div');
                emotionItem.className = 'emotion-item';
                emotionItem.innerHTML = `
                    <span class="emotion-label">${emotion}:</span>
                    <div class="emotion-bar">
                        <div class="emotion-fill" style="width: ${score}%"></div>
                    </div>
                    <span class="emotion-score">${score}%</span>
                `;
                emotionsChart.appendChild(emotionItem);
            });
        }
    }
    
    // Намерения
    if (data.intent) {
        const intentList = document.getElementById('intent-list');
        intentList.innerHTML = '';
        
        if (data.intent.intents) {
            data.intent.intents.forEach(intent => {
                const intentItem = document.createElement('div');
                intentItem.className = 'intent-item';
                intentItem.innerHTML = `
                    <span class="intent-name">${intent.name}</span>
                    <span class="intent-confidence">${intent.confidence}%</span>
                `;
                intentList.appendChild(intentItem);
            });
        }
    }
    
    // Сущности
    if (data.entities) {
        const entitiesContainer = document.getElementById('entities-container');
        entitiesContainer.innerHTML = '';
        
        if (data.entities.entities) {
            data.entities.entities.forEach(entity => {
                const entityTag = document.createElement('span');
                entityTag.className = 'tag';
                entityTag.textContent = `${entity.type}: ${entity.value}`;
                entitiesContainer.appendChild(entityTag);
            });
        }
    }
    
    // Уверенность
    if (data.confidence) {
        const confidenceValue = document.getElementById('confidence-value');
        const confidenceFill = document.getElementById('confidence-fill');
        
        confidenceValue.textContent = `${data.confidence}%`;
        confidenceFill.style.width = `${data.confidence}%`;
        confidenceFill.className = `confidence-fill ${getConfidenceClass(data.confidence)}`;
    }
    
    // Краткое содержание
    if (data.summary) {
        document.getElementById('summary-text').textContent = data.summary;
    }
    
    // Рекомендации
    if (data.recommendations) {
        const recommendationsList = document.getElementById('recommendations-list');
        recommendationsList.innerHTML = '';
        
        data.recommendations.forEach(rec => {
            const li = document.createElement('li');
            li.textContent = rec;
            recommendationsList.appendChild(li);
        });
    }
    
    // Прокрутка к результатам
    document.getElementById('results-section').scrollIntoView({ behavior: 'smooth' });
}

// Вспомогательные функции
function getSentimentClass(sentiment) {
    switch(sentiment?.toLowerCase()) {
        case 'positive': return 'text-success';
        case 'negative': return 'text-danger';
        case 'neutral': return 'text-secondary';
        default: return 'text-muted';
    }
}

function getConfidenceClass(confidence) {
    if (confidence >= 80) return 'high-confidence';
    if (confidence >= 60) return 'medium-confidence';
    return 'low-confidence';
}

// Экспорт анализа
function exportAnalysis() {
    // Реализация экспорта
    showAlert('Экспорт анализа начался', 'success');
}

// Загрузка истории при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    loadHistory();
});

// Загрузка истории анализов
async function loadHistory() {
    try {
        const response = await fetch('/api/v1/nlp/history');
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const history = await response.json();
        updateHistoryTable(history);
        
    } catch (error) {
        console.error('Ошибка при загрузке истории:', error);
        // Не показываем ошибку пользователю, так как это не критично
    }
}

// Обновление таблицы истории
function updateHistoryTable(history) {
    const tbody = document.getElementById('history-table-body');
    tbody.innerHTML = '';
    
    if (history.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" class="text-center text-muted">
                    <i class="fas fa-inbox me-2"></i>История анализов пуста
                </td>
            </tr>
        `;
        return;
    }
    
    history.forEach(item => {
        const row = document.createElement('tr');
        row.innerHTML = `
            <td>${new Date(item.date).toLocaleString('ru-RU')}</td>
            <td><span class="badge">${item.analysis_type}</span></td>
            <td>
                <span class="badge ${getSentimentClass(item.sentiment)}">
                    ${item.sentiment || 'Не определено'}
                </span>
            </td>
            <td>${item.confidence || 0}%</td>
            <td>
                <button class="btn btn-sm btn-outline-primary" onclick="viewHistoryDetail('${item.id}')">
                    <i class="fas fa-eye"></i>
                </button>
            </td>
        `;
        tbody.appendChild(row);
    });
}

// Просмотр деталей из истории
async function viewHistoryDetail(id) {
    try {
        const response = await fetch(`/api/v1/nlp/history/${id}`);
        if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        document.getElementById('analysis-detail').innerHTML = `
            <div class="row">
                <div class="col-md-6">
                    <h6>Информация об анализе</h6>
                    <p><strong>Дата:</strong> ${new Date(data.date).toLocaleString('ru-RU')}</p>
                    <p><strong>Тип анализа:</strong> ${data.analysis_type}</p>
                    <p><strong>Модель:</strong> ${data.model}</p>
                    <p><strong>Уверенность:</strong> ${data.confidence}%</p>
                </div>
                <div class="col-md-6">
                    <h6>Результаты</h6>
                    <p><strong>Настроение:</strong> ${data.sentiment || 'Не определено'}</p>
                    <p><strong>Основное намерение:</strong> ${data.intent || 'Не определено'}</p>
                    <p><strong>Количество сущностей:</strong> ${data.entities_count || 0}</p>
                </div>
            </div>
            <hr>
            <div class="row">
                <div class="col-12">
                    <h6>Анализируемый текст</h6>
                    <div class="bg-light p-3 rounded">
                        <pre>${data.text || 'Текст недоступен'}</pre>
                    </div>
                </div>
            </div>
        `;
        
        new bootstrap.Modal(document.getElementById('detailModal')).show();
        
    } catch (error) {
        console.error('Ошибка при загрузке деталей:', error);
        showAlert('Ошибка при загрузке деталей: ' + error.message, 'danger');
    }
}
</script>
{% endblock %}
