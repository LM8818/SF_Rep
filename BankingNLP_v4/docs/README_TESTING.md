# Документация по тестированию BankingNLP_v2

## Где находятся тесты

Все тесты проекта находятся в папке:
```
app/tests/
```

## Как запускать тесты

1. Перейдите в корневую папку проекта:
   ```bash
   cd /path/to/BankingNLP_v2
   ```
2. Запустите все тесты:
   ```bash
   python3 -m pytest app/tests -v
   ```
   Или отдельный файл:
   ```bash
   python3 -m pytest app/tests/test_prompts.py -v
   ```

## Структура тестов

- **test_prompts.py** — тесты бизнес-логики работы с промтами (PromptManager, шаблоны, сериализация, форматирование и т.д.).
- **test_prompts_api.py** — тесты API-эндпоинтов для управления промтами (создание, получение, обновление, удаление, форматирование через HTTP).
- **test_benchmark.py** и др. — тесты для других сервисов и API.

## Как устроены тесты

- Для изоляции тестов используются мок-объекты (mock) и подмена зависимостей через FastAPI dependency_overrides.
- Тесты не зависят от реальных файлов, базы данных или внешних сервисов.
- Каждый тест проверяет отдельный сценарий: успешный, ошибочный, граничные случаи.

## Примеры тестов

### Пример бизнес-логики (test_prompts.py)
```python
def test_format_prompt(self, prompt_manager):
    formatted = prompt_manager.format_prompt(
        "topic_extraction_v1",
        conversation_text="Тестовый разговор"
    )
    assert "Тестовый разговор" in formatted
```

### Пример API-теста (test_prompts_api.py)
```python
def test_create_prompt(self, override_prompt_manager):
    override_prompt_manager.get_prompt.return_value = None
    request_data = {...}
    response = client.post("/api/v1/prompts/", json=request_data)
    assert response.status_code == 200
```

## Как добавить свой тест

1. Создайте новый файл или функцию в папке `app/tests/`.
2. Имя функции должно начинаться с `test_`.
3. Используйте Pytest и, при необходимости, мок-объекты для изоляции.

## Как понять, что тесты прошли

- В консоли вы увидите строки вида:
  ```
  =================== 20 passed in 0.15s ===================
  ```
- Если есть ошибки, они будут подробно описаны.

## Зачем нужны тесты

- Проверяют, что изменения не ломают существующую логику.
- Позволяют быстро находить и исправлять ошибки.
- Гарантируют стабильность API для фронтенда и интеграций.

## Структура логов в тестах

В тестах проекта используется расширенное логирование на русском языке для повышения информативности и удобства анализа. 

### Принципы логирования:
- **Единый формат сообщений:**
  - `ТЕСТ: <название> | ВХОД: <...> | ОЖИДАЕМО: <...> | РЕЗУЛЬТАТ: <успешно/ошибка/предупреждение>`
- **Категоризация по уровням:**
  - `logger.info` — успешные проверки
  - `logger.warning` — ожидаемые ошибки/исключения
  - `logger.error` — неожиданные сбои
- **Идентификаторы тестов:**
  - В каждом сообщении указывается имя теста (или его уникальный идентификатор).
- **Логирование входных данных и ожидаемых результатов:**
  - Для сложных тестов логируются ключевые параметры, входные данные, ожидаемые и фактические результаты.
- **Логирование времени выполнения:**
  - Для каждого теста логируется время старта, окончания и длительность выполнения.
- **Логирование начала и конца файла:**
  - В начале и конце каждого файла тестов логируется старт и завершение всех тестов в этом файле.

### Пример лога для одного теста
```
2024-06-10 12:00:00 [INFO] ТЕСТ: test_add_prompt | ВХОД: name=Тестовый | ОЖИДАЕМО: prompt добавлен | РЕЗУЛЬТАТ: успешно | Время: 0.002 сек
2024-06-10 12:00:00 [INFO] ТЕСТ: test_add_prompt | Завершение теста
```

### Рекомендации
- Все новые тесты и тестовые файлы должны использовать данную структуру логов по умолчанию.
- Для параметризованных тестов рекомендуется явно логировать параметры запуска.
- Для тестов, ожидающих ошибку, используйте `logger.warning`.
- Для неожиданных сбоев используйте `logger.error`.

---

Остальная информация по запуску и структуре тестов — см. ниже. 