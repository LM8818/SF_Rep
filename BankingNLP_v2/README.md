

# BankingNLP_v2 - Промышленная NLP-система для банковского сектора

## Бизнес-требования

### Цель
Создание интеллектуальной системы для автоматического выделения тематик и продуктовых упоминаний из транскрибированных разговоров с клиентами с целью повышения качества обслуживания, конверсии продаж и оптимизации продуктовой линейки.

### Ключевые функциональные требования

1. **Автоматическое распознавание не менее 50 тематик, включая:**
   - Финансовые продукты и услуги (кредиты, вклады, инвестиции, страхование и т.д.)
   - Проблемные ситуации (технические сбои, претензии, вопросы безопасности)
   - Жизненные события клиентов (свадьба, рождение ребенка, покупка жилья)
   - Конкурентные предложения (упоминания других банков и их продуктов)

2. **Анализ продуктовых упоминаний:**
   - Идентификация продуктов банка в разговоре
   - Определение контекста упоминания (интерес, отказ, сравнение)
   - Выявление причин отказа от продуктов

3. **Автоматическая классификация эмоционального окраса обсуждения каждой тематики и продукта**

4. **Формирование инсайтов:**
   - Выявление наиболее востребованных продуктов
   - Определение болевых точек в обслуживании
   - Идентификация незакрытых потребностей клиентов

### Технические требования

1. **Производительность системы:**
   - Обработка не менее 10,000 транскриптов ежедневно
   - Время анализа одного разговора – не более 2 минут
   - Точность определения тематик не менее 85%

2. **Интеграционные возможности:**
   - API для подключения к CRM-системе банка
   - Интеграция с системой транскрибирования звонков

### Ожидаемые бизнес-результаты

- Увеличение конверсии продаж на 15-20% за счет выявления скрытых потребностей
- Снижение оттока клиентов на 10% благодаря раннему выявлению проблемных ситуаций
- Оптимизация продуктовой линейки на основе реальных потребностей клиентов

## Модули проекта

## Описание модулей проекта BankingNLP_v2

| Модуль                | Назначение                                                                                  | Краткое описание для неспециалистов                                                                                 |
|-----------------------|--------------------------------------------------------------------------------------------|---------------------------------------------------------------------------------------------------------------------|
| **app/**              | Основное приложение и бизнес-логика                                                        | Сердце системы: отвечает за обработку запросов, анализ текстов, работу с пользователями и интеграцию с другими частями проекта. |
| **app/api/**          | Внешний интерфейс (API)                                                                    | Позволяет другим программам и сервисам обращаться к системе для анализа текстов, получения отчетов и управления.     |
| **app/services/**     | Бизнес-логика и интеграция                                                                 | Здесь происходит основной "умный" анализ: обработка текстов, вызов малой LLM, формирование аналитики и алертов.     |
| **app/schemas/**      | Проверка и описание данных                                                                 | Определяет, как должны выглядеть входящие и исходящие данные, чтобы система работала стабильно и безопасно.         |
| **app/core/**         | Настройки, база данных, безопасность                                                       | Хранит параметры работы системы, отвечает за подключение к базе данных и защиту от несанкционированного доступа.    |
| **app/models/**       | Описание структуры данных                                                                  | Описывает, как информация хранится в базе данных: пользователи, разговоры, отчеты и т.д.                           |
| **app/utils/**        | Вспомогательные инструменты                                                                | Помогают с обработкой файлов, логированием и другими техническими задачами.                                         |
| **frontend/**         | Веб-интерфейс                                                                              | Удобные формы и дашборды для операторов и аналитиков, чтобы видеть результаты анализа и отчеты.                     |
| **src/**              | Ядро обработки текстов и машинного обучения                                                | Здесь происходит подготовка данных, обучение и запуск моделей для анализа текстов.                                   |
| **configs/**          | Конфигурационные файлы                                                                     | Хранят параметры для моделей, логирования, работы малой LLM и другие настройки.                                     |
| **data/**             | Данные проекта                                                                             | Сырые и обработанные данные для обучения и тестирования моделей.                                                    |
| **models/**           | Сохранённые модели                                                                         | Файлы с обученными моделями, которые используются для анализа новых текстов.                                        |
| **nginx/**            | Проксирование и отдача статики                                                             | Обеспечивает быстрый и безопасный доступ к веб-интерфейсу и API.                                                    |
| **infrastructure/**   | Docker, Kubernetes, CI/CD                                                                  | Автоматизация запуска, обновления и масштабирования системы.                                                        |
| **notebooks/**        | Jupyter-блокноты                                                                           | Файлы для экспериментов и анализа данных в удобном формате.                                                         |
| **tests/**            | Тесты                                                                                      | Проверяют, что все части системы работают правильно и без ошибок.                                                   |
| **scripts/**          | Вспомогательные скрипты                                                                    | Автоматизируют рутинные задачи: миграции базы, загрузку данных, деплой моделей.                                     |
| **docs/**             | Документация и диаграммы                                                                   | Описывает, как работает система, и содержит схемы для наглядности.                                                  |
| **reports/**          | Отчёты и графики                                                                           | Визуализация результатов анализа для руководства и аналитиков.                                                      |
| **logs/**             | Логи работы системы                                                                        | Хранят все важные события, ошибки и действия пользователей для аудита и мониторинга.                                |

---

## Описание компонентов системы BankingNLP_v2 (простым языком)

| Компонент                | Описание                                                                                                   | Для чего нужен и как работает                                                                                      |
|--------------------------|------------------------------------------------------------------------------------------------------------|--------------------------------------------------------------------------------------------------------------------|
| **FastAPI Backend**      | Главный сервер системы                                                                                     | Принимает запросы, управляет анализом текстов, хранит и отдаёт результаты, обеспечивает безопасность.              |
| **NLP Service**          | Анализ текстов и разговоров                                                                                | "Понимает" смысл текста, определяет тему, эмоцию, продукты и уровень удовлетворённости клиента.                    |
| **LLM Service (малая LLM)** | Умная языковая модель (например, Phi-2)                                                                  | Быстро и локально определяет тематику и смысл текста, не обращаясь к внешним сервисам, работает даже без интернета. |
| **Analytics Service**    | Бизнес-аналитика                                                                                           | Считает статистику, строит отчёты и графики по темам, продуктам, эмоциям и другим важным показателям.              |
| **Monitoring Service**   | Мониторинг и алерты                                                                                        | Следит за качеством работы системы, вовремя сообщает о сбоях, ошибках или подозрительных событиях.                  |
| **Integration Service**  | Интеграция с другими системами                                                                             | Передаёт результаты анализа в CRM, хранилища данных и другие банковские сервисы.                                   |
| **Security**             | Безопасность и контроль доступа                                                                            | Защищает систему от несанкционированного доступа, управляет ролями пользователей и ограничивает частоту запросов.   |
| **Frontend**             | Веб-интерфейс для пользователей                                                                            | Позволяет операторам и аналитикам удобно работать с системой через браузер: запускать анализ, смотреть отчёты.     |
| **PostgreSQL**           | База данных                                                                                               | Надёжно хранит все разговоры, результаты анализа, отчёты, пользователей и логи.                                    |
| **Kafka**                | Очередь событий                                                                                            | Помогает обрабатывать большие объёмы данных и связывать разные части системы между собой.                          |
| **Prometheus & Grafana** | Мониторинг и визуализация                                                                                  | Системы для сбора и красивого отображения метрик работы и состояния системы.                                       |
| **Alerting System**      | Система оповещений                                                                                         | Автоматически уведомляет ответственных сотрудников о важных событиях и проблемах.                                   |
| **Docker/Kubernetes**    | Контейнеризация и управление инфраструктурой                                                               | Позволяет запускать и обновлять систему быстро, надёжно и на разных серверах или в облаке.                         |
| **CI/CD Pipeline**       | Автоматизация тестирования и обновлений                                                                    | Проверяет, что новые версии системы работают правильно, и автоматически выкатывает их в работу.                    |
| **Логирование**          | Запись всех событий и ошибок                                                                               | Сохраняет информацию о работе системы, ошибках и действиях пользователей для аудита, поиска проблем и безопасности.|

---

**Все компоненты и модули системы работают вместе, чтобы обеспечить надёжный, быстрый и безопасный анализ клиентских разговоров, автоматическую генерацию бизнес-отчётов и удобную работу для операторов и аналитиков, а также прозрачность и контроль для руководства и службы безопасности.**


 
## Шаги развертывания приложения

### Системные требования

- **Операционная система:** Linux/macOS/Windows 10+
- **Python:** 3.11+
- **Docker:** 20.10+
- **Docker Compose:** 2.0+
- **RAM:** минимум 8GB, рекомендуется 16GB
- **Диск:** 10GB свободного места

### 1. Подготовка окружения
 
# Клонирование репозитория
git clone https://github.com/LM8818/SF_Rep.git
cd SF_Rep/BankingNLP_v2

# Создание виртуального окружения
python -m venv venv
source venv/bin/activate  # На Windows: venv\Scripts\activate

# Установка зависимостей
pip install -r requirements.txt
 

### 2. Настройка конфигурации


# Копирование шаблона переменных окружения
cp .env.template .env

# Редактирование .env файла (укажите свои значения)
nano .env
 

Пример .env файла:

 
SECRET_KEY=your-secret-key-here
DATABASE_URL=postgresql://user:password@localhost:5432/bankingnlp
LOG_LEVEL=INFO
API_V1_STR=/api/v1
 

### 3. Локальный запуск (без Docker)
 
# Запуск полного ML пайплайна
python run.py all

# Или запуск отдельных этапов
python run.py data      # Загрузка и очистка данных
python run.py features  # Генерация признаков
python run.py train     # Обучение модели
python run.py predict   # Инференс
python run.py eval      # Оценка качества

# Запуск веб-приложения
uvicorn app.main:app --host 0.0.0.0 --port 8000 --reload
 

### 4. Запуск через Docker Compose (рекомендуется)

 
# Создание виртуального окружения и установка зависимостей
python run.py venv

# Сборка и запуск всех контейнеров
docker-compose up --build -d

# Проверка статуса контейнеров
docker-compose ps

# Просмотр логов
docker-compose logs -f web

# Инициализация базы данных (если требуется)
docker-compose exec web python scripts/db_migration.py
 

### 5. Проверка работоспособности

После успешного запуска приложение будет доступно по следующим адресам:

- **Веб-интерфейс:** http://localhost:8080
- **API документация (Swagger):** http://localhost:8080/docs
- **ReDoc документация:** http://localhost:8080/redoc
- **Статус здоровья:** http://localhost:8080/health
- **Метрики (Prometheus):** http://localhost:8080/metrics

### 6. Запуск тестов

 
# Запуск всех тестов
docker-compose exec web pytest

# Запуск с покрытием
docker-compose exec web pytest --cov=app tests/

# Запуск только unit-тестов
docker-compose exec web pytest tests/unit/

# Запуск интеграционных тестов
docker-compose exec web pytest tests/integration/
 

### 7. Развертывание в продакшене

 
# Применение Kubernetes манифестов
kubectl apply -f infrastructure/k8s/

# Мониторинг развертывания
kubectl get pods -n bankingnlp --watch

# Проверка логов
kubectl logs -f deployment/bankingnlp-web -n bankingnlp
 



> # Структура проекта

``````

BankingNLP_v2/
├── .github/                  # Конфигурация CI/CD и автоматизации (GitHub Actions, рендер UML)
│   └── workflows/            # YAML-файлы для автотестов, деплоя, генерации диаграмм
│
├── app/                      # Основное FastAPI-приложение (бэкенд)
│   ├── api/                  # REST API, версионирование и роутеры
│   │   └── api_v1/           # Версия 1 API
│   │       ├── endpoints/    # Эндпоинты: аналитика, NLP, мониторинг, аутентификация
│   │       │   ├── analytics.py   # Эндпоинты бизнес-аналитики
│   │       │   ├── auth.py        # Эндпоинты аутентификации и авторизации
│   │       │   ├── monitoring.py  # Эндпоинты мониторинга и алертов
│   │       │   └── nlp.py         # Эндпоинты NLP-анализа и классификации
│   │       └── api.py        # Главный роутер для API v1
│   ├── core/                 # Ядро приложения: конфиг, база, безопасность
│   │   ├── config.py         # Загрузка и хранение настроек приложения
│   │   ├── database.py       # Подключение к БД и сессии
│   │   └── security.py       # JWT, OAuth2, rate limiting, безопасность
│   ├── models/               # ORM-модели для хранения данных в БД
│   │   ├── conversation.py   # Модель диалога/разговора
│   │   ├── analytics.py      # Модель аналитических данных
│   │   └── user.py           # Модель пользователя системы
│   ├── schemas/              # Pydantic-схемы для валидации API
│   │   ├── analytics.py      # Схемы для аналитики
│   │   ├── auth.py           # Схемы для аутентификации
│   │   └── nlp.py            # Схемы для NLP-запросов/ответов
│   ├── services/             # Бизнес-логика, интеграции, обработка
│   │   ├── analytics_service.py   # Генерация отчётов и аналитики
│   │   ├── auth_service.py        # Логика аутентификации
│   │   ├── integration_service.py # Интеграция с внешними системами (CRM, DWH)
│   │   ├── llm_service.py         # Сервис малой LLM (Phi-2, Mistral и др.)
│   │   ├── monitoring_service.py  # Мониторинг метрик и генерация алертов
│   │   └── nlp_service.py         # Основной NLP-анализ и классификация
│   ├── utils/                # Вспомогательные утилиты (логирование, работа с файлами)
│   │   ├── file_utils.py
│   │   └── logging_utils.py
│   ├── main.py               # Точка входа FastAPI-приложения
│   └── dependencies.py       # Общие зависимости для роутеров
│
├── configs/                  # Конфигурация моделей, логирования, LLM
│   ├── model_config.yaml     # Параметры ML/LLM моделей
│   ├── bert_config.yaml      # Параметры для ruBERT/LLM
│   └── logging_config.yaml   # Настройки логирования
│
├── data/                     # Данные проекта (сырьё, промежуточные, обработанные)
│   ├── external/             # Внешние данные (от партнёров, открытые источники)
│   ├── interim/              # Промежуточные файлы обработки
│   ├── processed/            # Готовые к анализу данные
│   └── raw/                  # Исходные, не обработанные данные
│
├── docs/                     # Документация и UML-диаграммы
│   ├── uml/                  # PlantUML-диаграммы процессов, компонентов, развертывания
│   │   ├── activity_pipeline.puml
│   │   ├── component_system.puml
│   │   ├── deployment.puml
│   │   └── sequence_analyze.puml
│   ├── api_documentation.md  # Подробное описание API
│   └── user_guide.md         # Руководство пользователя
│
├── frontend/                 # Веб-интерфейс (шаблоны, статика, формы)
│   ├── static/               # CSS, JS, изображения для фронта
│   │   ├── css/
│   │   ├── js/
│   │   └── img/
│   ├── templates/            # Jinja2-шаблоны страниц (аналитика, тесты, дашборд)
│   │   ├── analytics.html
│   │   ├── base.html
│   │   ├── dashboard.html
│   │   ├── index.html
│   │   └── test_forms.html
│   └── Dockerfile            # Dockerfile для фронтенда
│
├── infrastructure/           # Docker, Kubernetes, деплой
│   ├── docker/               # Dockerfile для backend, frontend, nginx
│   │   ├── backend.dockerfile
│   │   ├── frontend.dockerfile
│   │   └── nginx.dockerfile
│   └── k8s/                  # Kubernetes-манифесты (деплой, сервис, ingress)
│       ├── deployment.yaml
│       ├── service.yaml
│       └── ingress.yaml
│
├── models/                   # Сохранённые ML/LLM-модели
│   ├── production/           # Продакшен-версии моделей
│   └── staging/              # Тестовые/экспериментальные модели
│
├── nginx/                    # Конфигурация Nginx (проксирование, отдача статики)
│   ├── nginx.conf
│   └── Dockerfile
│
├── notebooks/                # Jupyter-блокноты для EDA и экспериментов
│   ├── data_exploration.ipynb
│   └── model_experiments.ipynb
│
├── reports/                  # Отчёты, графики, метрики для аналитиков
│   ├── figures/
│   └── metrics/
│
├── scripts/                  # Вспомогательные скрипты (миграции, деплой, запуск)
│   ├── db_migration.py       # Миграция и инициализация БД
│   ├── deploy_model.py       # Скрипт деплоя моделей
│   ├── setup.sh              # Bash-скрипты настройки окружения
│   └── wait-for-db.sh        # Ожидание готовности БД при запуске
│
├── src/                      # Ядро NLP (обработка, ML, признаки)
│   ├── config/
│   │   ├── config.py
│   │   ├── config.yaml
│   │   └── logging.yaml
│   ├── data/
│   │   └── load_data.py      # Загрузка и обработка данных
│   ├── evaluation/
│   │   └── evaluate.py       # Оценка качества моделей
│   ├── features/
│   │   └── build_features.py # Генерация признаков
│   ├── models/
│   │   ├── predict_model.py  # Инференс
│   │   └── train_model.py    # Обучение моделей
│   └── utils/
│       └── preprocessing.py  # Предобработка текста
│
├── tests/                    # Unit- и интеграционные тесты
│   ├── integration/          # Интеграционные тесты сервисов
│   ├── unit/                 # Юнит-тесты компонентов
│   │   ├── test_api.py
│   │   ├── test_services.py
│   │   └── test_utils.py
│   └── conftest.py           # Фикстуры Pytest
│
├── .dockerignore             # Исключения для Docker-сборки
├── .env.template             # Шаблон переменных окружения
├── .gitignore                # Исключения для Git
├── bankingnlp.db             # SQLite база для отладки
├── docker-compose.yml        # Компоновка сервисов для локального запуска
├── logging.yaml              # Глобальная настройка логирования
├── Makefile                  # Автоматизация задач (build, test, lint)
├── pyproject.toml            # Конфигурация Python-пакета
├── README.md                 # Основная документация
├── requirements.txt          # Зависимости Python
├── run.py                    # Запуск ML-пайплайна
└── setup.py                  # Установка пакета



``````


## Описание системы логирования в README

В проекте BankingNLP_v2 реализована промышленная система логирования, обеспечивающая аудит, мониторинг и диагностику для всех компонентов — от основного приложения до вспомогательных скриптов.

### Как работает логирование

- **Централизованная настройка:**  
  Конфигурация логирования хранится в файле `logging.yaml` или `logging_config.yaml` в корне проекта.  
  При запуске приложения или любого скрипта происходит автоматическая загрузка этой конфигурации.  
  Если файл не найден — включается базовая логика с выводом в консоль.

- **Многоуровневая маршрутизация:**  
  Логи пишутся одновременно в:
  - Консоль (stdout)
  - Файлы в папке `logs/` (например, `logs/app.log`), с поддержкой ротации и архивирования
  - (Опционально) Внешние системы мониторинга и агрегации (например, ELK, Grafana Loki, Prometheus)

- **Форматы и уровни:**  
  Поддерживаются текстовый и JSON-формат логов для удобства интеграции с аналитическими платформами[1].  
  Уровни логирования: DEBUG, INFO, WARNING, ERROR, CRITICAL.

- **Аудит действий и бизнес-логика:**  
  Логируются все ключевые события:  
  - Запуск и завершение этапов пайплайна  
  - Ошибки и исключения  
  - Действия пользователей и сервисов  
  - Вызовы API и интеграций  
  - Системные алерты и бизнес-события

- **Поддержка во всех скриптах:**  
  Даже вспомогательные утилиты (миграции, загрузка данных, деплой моделей) используют централизованную настройку логирования — для этого в начале каждого скрипта автоматически подгружается конфиг и создаётся именованный логгер.

### Пример конфигурации логирования (logging.yaml)

```yaml
version: 1
disable_existing_loggers: False
formatters:
  default:
    format: "%(asctime)s - %(name)s - %(levelname)s - %(message)s"
  json:
    format: '{"timestamp": "%(asctime)s", "logger": "%(name)s", "level": "%(levelname)s", "message": "%(message)s"}'
handlers:
  console:
    class: logging.StreamHandler
    formatter: default
    level: DEBUG
    stream: ext://sys.stdout
  file:
    class: logging.FileHandler
    formatter: json
    level: INFO
    filename: ./logs/app.log
loggers:
  app:
    handlers: [console, file]
    level: DEBUG
    propagate: False
root:
  handlers: [console]
  level: INFO
```

### Как использовать логирование в своих скриптах

```python
import logging
import yaml

# Загрузка конфигурации логирования
try:
    with open("logging.yaml", encoding="utf-8") as f:
        config = yaml.safe_load(f)
    logging.config.dictConfig(config)
except Exception:
    logging.basicConfig(level=logging.INFO)
    logging.getLogger().warning("Не удалось загрузить logging.yaml – используется базовая конфигурация.")

logger = logging.getLogger(__name__)

logger.info("Запуск скрипта загрузки данных")
logger.error("Ошибка при подключении к БД: %s", err)
```

### Где искать логи

- **В консоли** — при запуске приложения или скриптов.
- **В папке `logs/`** — все события сохраняются в файл (например, `logs/app.log`), доступен аудит и последующая агрегация для бизнес-аналитики[1].
- **В системах мониторинга** — при интеграции с ELK, Prometheus, Grafana Loki и др.

### Рекомендации

- Убедитесь, что папка `logs/` создана и доступна для записи.
- Для production используйте JSON-формат и настройте ротацию файлов.
- Для агрегации логов используйте стандартные решения (ELK, Loki, Prometheus) — это позволит строить отчёты и быстро реагировать на инциденты.

---

**Система логирования BankingNLP_v2 обеспечивает прозрачность, аудит и безопасность на всех этапах работы — от загрузки данных до бизнес-аналитики и мониторинга[1][2].**

Источники
[1] Проекты projects.data_reporting
[2] Навыки skills.project_documentation


Краткое описание процесса
	•	Генерация логов:
Все сервисы (FastAPI backend, NLP сервис, малые LLM, интеграции, фронтенд) отправляют структурированные логи через централизованный логгер.
	•	Обработка логов:
Логи проходят через систему форматирования (например, JSON), фильтруются по уровню важности и маршрутизируются в разные обработчики.
	•	Хранение логов:
	•	Файловое хранение: Логи записываются в файлы (`logs/app.log`, с ротацией и архивированием).
	•	Централизованные системы: Логи могут направляться в внешние сервисы мониторинга и агрегации (например, ELK, Grafana Loki, Prometheus), что позволяет строить отчёты и проводить аудит.
	•	Генерация алертов:
При обнаружении ошибок, сбоев или подозрительных событий система логирования может автоматически создавать алерты и уведомлять ответственных сотрудников или внешние системы безопасности.
Такая архитектура обеспечивает прозрачность, аудит, быструю диагностику и промышленную надёжность всей платформы BankingNLP_v2.



